{% extends "base.html" %}
{% block content %}
<div class="tc-card">

<style>
  .grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
    gap: 1rem;
  }
  .card {
    border: 1px solid var(--border);
    border-radius: 10px;
    padding: 0.9rem;
    background: var(--card);
    position: relative;
    box-shadow: 0 8px 18px rgba(15,23,42,0.06);
  }
  .label {
    font-size: 0.85rem;
    color: var(--muted);
    margin-bottom: 0.35rem;
  }
  .muted {
    color: var(--muted);
    font-size: 0.9rem;
  }
  .mono {
    font-family: Consolas, "SFMono-Regular", Menlo, monospace;
    font-size: 0.9rem;
    background: #f3f4f6;
    border: 1px solid var(--border);
    border-radius: 8px;
    padding: 0.6rem;
    word-break: break-all;
  }
  body.dark .mono {
    background: #020617;
  }
  .row {
    display: flex;
    gap: 0.5rem;
    align-items: center;
  }
  textarea {
    width: 100%;
    border-radius: 8px;
    border: 1px solid var(--border);
    padding: 0.6rem;
    min-height: 90px;
    font-family: inherit;
  }
  input[type="text"], input[type="url"] {
    width: 100%;
    border-radius: 8px;
    border: 1px solid var(--border);
    padding: 0.6rem;
    font-family: inherit;
  }
  .pill-plan {
    padding: 0.2rem 0.6rem;
    border-radius: 999px;
    border: 1px solid var(--border);
    font-size: 0.85rem;
    background: var(--card);
  }
  .list {
    list-style: disc;
    padding-left: 1.1rem;
    margin: 0.35rem 0;
    color: var(--muted);
    font-size: 0.9rem;
  }
  .usage-row {
    display: flex;
    justify-content: space-between;
    font-size: 0.9rem;
    margin: 0.3rem 0;
  }
  .small {
    font-size: 0.85rem;
  }

  .icon-button {
    border: 1px solid var(--border);
    background: var(--card);
    padding: 0.3rem;
    border-radius: 10px;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    transition: background 0.15s ease, border-color 0.15s ease;
  }

  .icon-button:hover {
    background: rgba(37, 99, 235, 0.08);
    border-color: #2563eb;
  }
</style>

<div style="display:flex;align-items:center;justify-content:space-between;gap:0.75rem;flex-wrap:wrap;margin-bottom:1rem;">
  <div>
    <h1 class="tc-h1" style="margin:0 0 0.35rem;">Business settings</h1>
    <div class="muted">Configure your TheoChat embed and business profile.</div>
  </div>
  <div style="display:flex;align-items:center;gap:0.5rem;">
    <a href="{{ url_for('index') }}" class="pill-plan" style="text-decoration:none;">&larr; Back to home</a>
    {% if biz %}
      <div class="pill-plan">Plan: {{ current_user.plan|default('starter')|capitalize }}</div>
    {% endif %}
  </div>
</div>

{% if not biz %}
  <div class="card">
    <p style="margin:0;">No business found. Register or contact support.</p>
  </div>
{% else %}

<div class="grid">
  <div class="card">
    <div class="label">API key</div>
    <div class="row" style="justify-content:space-between;">
      <div class="mono" id="api-key" style="flex:1;">{{ biz.api_key }}</div>
      <button id="copy-key" type="button" class="primary tc-btn-primary" data-copy-target="#api-key">Copy</button>
    </div>
    <form method="post" action="{{ url_for('regenerate_key') }}" style="margin-top:0.6rem;">
      <button type="submit" class="danger">Regenerate key</button>
    </form>
  </div>

  <div class="card">
    <div class="label">Embed snippet</div>
    {% if not ready_for_embed %}
      <div class="muted small" style="margin-bottom:0.5rem;">
        Some sections (business knowledge, imports, or allowed domains) look incomplete.
        You can still generate the embed snippet, but embeds may not work as expected until everything is set up.
      </div>
    {% endif %}
    <button id="generate-snippet" type="button" class="primary tc-btn-primary">Generate embed snippet</button>
    <div id="snippet-block" style="display:none;margin-top:0.6rem;">
<div class="tc-code-box" id="embed-snippet">
<code id="embed-snippet-business">&lt;script
  src="https://theochat.co.uk/embed.js?api_key={{ biz.api_key }}"
  async
&gt;&lt;/script&gt;</code>
      </div>
      <button
        id="copy-snippet"
        type="button"
        class="tc-copy-btn"
        data-copy-target="#embed-snippet-business"
      >
        Copy snippet
      </button>
      <div class="row" style="margin-top:0.5rem;gap:0.5rem;">
        <button id="test-widget" type="button">Open test page</button>
      </div>
      <div class="muted" style="margin-top:0.4rem;">
        Paste this into your site builder. Tweak <code>data-panel-width</code> / <code>data-panel-height</code> to resize the widget.
        Lead capture: {% if biz.lead_capture_enabled %}enabled{% else %}disabled{% endif %}.
      </div>
    </div>
  </div>

  <div class="card">
    <div class="label">Usage today ({{ today }})</div>
    <div class="usage-row"><span>Messages</span><span>{{ usage_messages }} / {{ features.daily_messages }}</span></div>
    <div class="usage-row"><span>Uploads</span><span>{{ usage_uploads }} / {{ features.daily_uploads }}</span></div>
    <div class="label" style="margin-top:0.6rem;">Last 7 days</div>
    <div class="usage-row"><span>Messages</span><span>{{ usage_last7.messages }}</span></div>
    <div class="usage-row"><span>Uploads</span><span>{{ usage_last7.uploads }}</span></div>
    <div class="label" style="margin-top:0.6rem;">Plan features</div>
    <ul class="list">
      <li>Branding: {% if features.branding == 0 %}removable{% else %}required{% endif %}</li>
      <li>Domains: {{ features.domains }} allowed</li>
      <li>Notifications: {% if features.notifications %}email + SMS/WA{% else %}email at limit{% endif %}</li>
      <li>Storage: {{ chunk_usage }} / {{ features.max_chunks }} chunks</li>
    </ul>
  </div>

  {% if current_user.email|lower == ADMIN_EMAIL %}
  <div class="card">
    <div class="label">Admin: Plan override</div>
    <form id="plan-form">
      <label class="label" for="plan-select">Plan</label>
      <select id="plan-select" name="plan" class="tc-input" style="width:100%;padding:0.55rem;border-radius:8px;border:1px solid var(--border);">
        <option value="starter" {% if current_user.plan == "starter" %}selected{% endif %}>Starter</option>
        <option value="pro" {% if current_user.plan == "pro" %}selected{% endif %}>Pro</option>
        <option value="elite" {% if current_user.plan == "elite" %}selected{% endif %}>Elite</option>
      </select>
      <div class="row" style="margin-top:0.5rem;justify-content:flex-start;">
        <button class="primary tc-btn-primary" type="submit">Save plan</button>
        <div id="plan-status" class="muted small"></div>
      </div>
      <div class="muted small" style="margin-top:0.4rem;">
        Only visible for admin ({{ ADMIN_EMAIL }}). Updates limits & notifications immediately.
      </div>
    </form>
  </div>
  {% endif %}

  <div class="card">
    <div class="label">Business knowledge</div>
    <form id="knowledge-form">
      <label class="label" for="desc">Description</label>
      <textarea class="tc-input" id="desc" name="description" placeholder="What you do, who you serve...">{{ profile.description or '' }}</textarea>
      <label class="label" for="services">Services</label>
      <textarea class="tc-input" id="services" name="services" placeholder="List key services, pricing notes, deliverables...">{{ profile.services or '' }}</textarea>
      <label class="label" for="hours">Hours / contact</label>
      <textarea class="tc-input" id="hours" name="hours" placeholder="Hours, address, phone, response time...">{{ profile.hours or '' }}</textarea>
      <label class="label" for="faqs">FAQs</label>
      <textarea class="tc-input" id="faqs" name="faqs" placeholder="Q: ... A: ... (one per line)">{{ profile.faqs or '' }}</textarea>
      <label class="label" for="products">Products / services</label>
      <textarea class="tc-input" id="products" name="products" placeholder="List products/services, features, SKUs, options...">{{ profile.products or '' }}</textarea>
      <label class="label" for="pricing">Pricing notes</label>
      <textarea class="tc-input" id="pricing" name="pricing" placeholder="Pricing tiers, examples, fees, discounts...">{{ profile.pricing or '' }}</textarea>
      <label class="label" for="tone">Preferred tone of voice</label>
      <textarea class="tc-input" id="tone" name="tone" placeholder="Friendly, concise, formal, playful...">{{ profile.tone or '' }}</textarea>
      <div class="row" style="margin-top:0.5rem;justify-content:flex-start;">
        <button class="primary tc-btn-primary" type="submit">Save profile</button>
        <div id="knowledge-status" class="muted"></div>
      </div>
    </form>
  </div>

  <div class="card">
    <div class="label">Import website content (works on Starter)</div>
    <form id="import-form">
      <label class="label" for="import-url">Public URL</label>
      <input id="import-url" name="url" type="url" placeholder="https://yourdomain.com" class="tc-input" />
      <label class="label" for="import-mode" style="margin-top:0.4rem;">Mode</label>
      <select id="import-mode" name="mode" class="tc-input" style="width:100%;padding:0.55rem;border-radius:8px;border:1px solid var(--border);">
        <option value="single">Single page</option>
        <option value="crawl">Crawl same-domain (few pages)</option>
        <option value="sitemap">Sitemap.xml</option>
      </select>
      <label class="label" for="import-max-pages" style="margin-top:0.4rem;">Max pages</label>
      <input id="import-max-pages" name="max_pages" type="number" min="1" max="10" value="5" class="tc-input" />
      <div class="muted" style="margin-top:0.25rem;">Respects robots.txt, caps pages/size, and keeps within your domain.</div>
      <div class="row" style="margin-top:0.5rem;justify-content:flex-start;">
        <button class="primary tc-btn-primary" type="submit">Import</button>
        <div id="import-status" class="muted"></div>
      </div>
    </form>
  </div>

  <div class="card">
    <div class="label">Allowed domains ({{ features.domains }} max)</div>
    <form id="domains-form">
      <textarea class="tc-input" name="allowed_domains" placeholder="example.com, www.example.com" style="min-height:80px;">{{ biz.allowed_domains or '' }}</textarea>
      <div class="muted small">Visitor embeds will be rejected if the referrer host is not in this list.</div>
      <div class="row" style="margin-top:0.5rem;justify-content:flex-start;">
        <button class="primary tc-btn-primary" type="submit">Save domains</button>
        <div id="domains-status" class="muted"></div>
      </div>
    </form>
  </div>

  <div class="card">
    <div class="label">Lead capture</div>
    <p class="muted small" style="margin:0 0 0.5rem;">Require name/email/phone before answering.</p>
    <div class="row" style="justify-content:flex-start;">
      <button id="lead-toggle" type="button" class="primary tc-btn-primary" data-next="{{ 0 if biz.lead_capture_enabled else 1 }}">
        {% if biz.lead_capture_enabled %}Disable{% else %}Enable{% endif %}
      </button>
      <div id="lead-status" class="muted"></div>
    </div>
  </div>

  <div class="card">
    <div class="label">Notifications & Integrations</div>
    <form id="notify-form">
      <label class="label" for="contact_email" style="display:block;">Contact email</label>
      <input type="email" name="contact_email" id="contact_email" value="{{ biz.contact_email or '' }}" placeholder="alerts@example.com" style="width:100%;" />
      <label class="label" for="contact_phone" style="margin-top:0.4rem;display:block;">WhatsApp phone</label>
      <input type="tel" name="contact_phone" id="contact_phone" value="{{ biz.contact_phone or '' }}" placeholder="+44..." pattern="\\+?[0-9\\s-]{7,20}" title="Digits with optional leading +, spaces, or dashes" inputmode="tel" style="width:100%;" />
      <div class="muted small">Include country code, e.g. +44... +1... (international format).</div>
      <div style="display:flex;gap:0.5rem;margin-top:0.4rem;">
        <label><input type="checkbox" name="notify_email_enabled" value="1" {% if biz.notify_email_enabled %}checked{% endif %}> Email alerts</label>
        <label><input type="checkbox" id="notify-whatsapp" name="notify_whatsapp_enabled" value="1" {% if biz.notify_whatsapp_enabled %}checked{% endif %} {% if not features.notifications %}disabled{% endif %}> WhatsApp alerts (Pro+)</label>
      </div>
      <label class="label" for="webhook_url" style="margin-top:0.4rem;">Webhook URL</label>
      <input type="url" name="webhook_url" id="webhook_url" value="{{ biz.webhook_url or '' }}" placeholder="https://theochat.co.uk/webhooks/theochat" />
      <label class="label" for="hubspot_api_key" style="margin-top:0.4rem;">HubSpot API key (contacts)</label>
      <input type="text" name="hubspot_api_key" id="hubspot_api_key" value="{{ biz.hubspot_api_key or '' }}" placeholder="hs-api-key" />
      <div class="row" style="margin-top:0.5rem;justify-content:flex-start;">
        <button class="primary tc-btn-primary" type="submit">Save notifications</button>
        <div id="notify-status" class="muted"></div>
      </div>
    </form>
  </div>

  <div class="card">
    <div class="label">Wipe business context</div>
    <p class="muted" style="margin:0 0 0.5rem;">Removes uploaded files, website imports, and chat history for this business.</p>
    <div class="row" style="justify-content:flex-start;">
      <button id="wipe-context" class="danger" type="button">Wipe now</button>
      <div id="wipe-status" class="muted"></div>
    </div>
  </div>

  <div class="card">
    <div class="label">Sources</div>
    {% if sources %}
      <ul class="list">
        {% for s in sources %}
          <li style="display:flex;flex-direction:column;gap:0.35rem;">
            <div style="display:flex;justify-content:space-between;align-items:center;gap:0.5rem;">
              <span>{{ s.filename }} ({{ s.chunks }} chunks)</span>
              <form class="remove-source-form" data-filename="{{ s.filename }}" style="margin:0;">
                <button type="submit" class="danger" style="padding:0.2rem 0.5rem;font-size:0.8rem;">Remove</button>
              </form>
            </div>
            {% if s.filename == "website_import" %}
              <div class="mono" style="max-height:140px;overflow:auto;white-space:pre-wrap;">Source URL: {{ biz.last_import_url or "Not set" }}</div>
            {% else %}
              <div class="mono" style="max-height:140px;overflow:auto;white-space:pre-wrap;">{{ get_source_text(current_user.id|int, current_user.business_id|int, s.filename)[:500] }}{% if get_source_text(current_user.id|int, current_user.business_id|int, s.filename)|length > 500 %}...{% endif %}</div>
            {% endif %}
          </li>
        {% endfor %}
      </ul>
    {% else %}
      <div class="muted small">No sources yet.</div>
    {% endif %}
    <div id="source-status" class="muted"></div>
  </div>
</div>

{% endif %}

<script>
(function() {
  const keyEl = document.getElementById("api-key");
  const snippetEl = document.getElementById("embed-snippet-business");
  const testBtn = document.getElementById("test-widget");
  const knowledgeForm = document.getElementById("knowledge-form");
  const knowledgeStatus = document.getElementById("knowledge-status");
  const importForm = document.getElementById("import-form");
  const importStatus = document.getElementById("import-status");
  const wipeBtn = document.getElementById("wipe-context");
  const wipeStatus = document.getElementById("wipe-status");
  const domainsForm = document.getElementById("domains-form");
  const domainsStatus = document.getElementById("domains-status");
  const removeSourceForms = document.querySelectorAll(".remove-source-form");
  const sourceStatus = document.getElementById("source-status");
  const leadToggleBtn = document.getElementById("lead-toggle");
  const leadStatus = document.getElementById("lead-status");
  const generateBtn = document.getElementById("generate-snippet");
  const snippetBlock = document.getElementById("snippet-block");
  const isReady = {{ "true" if ready_for_embed else "false" }};
  const notifyForm = document.getElementById("notify-form");
  const notifyStatus = document.getElementById("notify-status");
  const whatsappCheckbox = document.getElementById("notify-whatsapp");
  const phoneInput = document.getElementById("contact_phone");
  const whatsappAllowed = {{ "true" if features.notifications else "false" }};
  const planForm = document.getElementById("plan-form");
  const planStatus = document.getElementById("plan-status");

  if (testBtn && snippetEl) {
    testBtn.addEventListener("click", () => {
      const snippet = snippetEl.innerText.trim();
      if (!snippet) return;
      const html = `
<!doctype html>
<html>
<head><meta charset="utf-8"><title>TheoChat test</title></head>
<body style="font-family:sans-serif;padding:16px;">
  <h3>TheoChat widget test</h3>
  <p style="color:#555;">This page embeds the same snippet shown in your portal.</p>
  ${snippet}
</body>
</html>`;
      const url = URL.createObjectURL(new Blob([html], { type: "text/html" }));
      window.open(url, "theochat-test");
      setTimeout(() => URL.revokeObjectURL(url), 5000);
    });
  }

  if (knowledgeForm) {
    knowledgeForm.addEventListener("submit", async (e) => {
      e.preventDefault();
      knowledgeStatus.textContent = "Saving...";
      const formData = new FormData(knowledgeForm);
      try {
        const res = await fetch("/business/knowledge", {
          method: "POST",
          body: formData
        });
        const data = await res.json();
        knowledgeStatus.textContent = res.ok && data.ok ? "Saved" : (data.error || "Error saving");
      } catch (err) {
        knowledgeStatus.textContent = "Network error";
      }
    });
  }

  if (importForm) {
    importForm.addEventListener("submit", async (e) => {
      e.preventDefault();
      importStatus.textContent = "Importing...";
      const formData = new FormData(importForm);
      try {
        const res = await fetch("/business/import_site", {
          method: "POST",
          body: formData
        });
        const data = await res.json();
        importStatus.textContent = res.ok && data.ok
          ? `Imported ${data.pages || 0} page(s), ${data.num_chunks} chunks`
          : (data.error || "Import failed");
      } catch (err) {
        importStatus.textContent = "Network error";
      }
    });
  }

  if (domainsForm) {
    domainsForm.addEventListener("submit", async (e) => {
      e.preventDefault();
      domainsStatus.textContent = "Saving...";
      const formData = new FormData(domainsForm);
      try {
        const res = await fetch("/business/domains", { method: "POST", body: formData });
        const data = await res.json();
        domainsStatus.textContent = res.ok && data.ok ? "Saved" : (data.error || "Save failed");
      } catch (err) {
        domainsStatus.textContent = "Network error";
      }
    });
  }

  if (removeSourceForms && removeSourceForms.length) {
    removeSourceForms.forEach((form) => {
      form.addEventListener("submit", async (e) => {
        e.preventDefault();
        const filename = form.getAttribute("data-filename");
        if (!filename) return;
        sourceStatus.textContent = "Removing...";
        try {
          const fd = new FormData();
          fd.append("filename", filename);
          const res = await fetch("/business/remove_source", { method: "POST", body: fd });
          const data = await res.json();
          sourceStatus.textContent = res.ok && data.ok ? `Removed ${filename}` : (data.error || "Remove failed");
        } catch (err) {
          sourceStatus.textContent = "Network error";
        }
      });
    });
  }

  if (wipeBtn) {
    wipeBtn.addEventListener("click", async () => {
      if (!confirm("This will delete uploaded files, website imports, and chat history. Continue?")) return;
      wipeStatus.textContent = "Wiping...";
      try {
        const res = await fetch("/business/wipe_context", { method: "POST" });
        const data = await res.json();
        wipeStatus.textContent = res.ok && data.ok ? "Context wiped" : (data.error || "Failed");
      } catch (err) {
        wipeStatus.textContent = "Network error";
      }
    });
  }

  if (leadToggleBtn) {
    leadToggleBtn.addEventListener("click", async () => {
      leadStatus.textContent = "Saving...";
      try {
        const fd = new FormData();
        fd.append("enabled", leadToggleBtn.getAttribute("data-next") || "0");
        const res = await fetch("/business/lead_capture", { method: "POST", body: fd });
        const data = await res.json();
        leadStatus.textContent = res.ok && data.ok ? `Lead capture ${data.enabled ? "enabled" : "disabled"}` : (data.error || "Failed");
      } catch (err) {
        leadStatus.textContent = "Network error";
      }
    });
  }

  if (generateBtn && snippetBlock) {
    generateBtn.addEventListener("click", () => {
      if (!isReady) {
        const ok = confirm("Some sections are incomplete or domains are missing/invalid. Continue?");
        if (!ok) return;
      }
      snippetBlock.style.display = "block";
    });
  }

  if (notifyForm) {
    notifyForm.addEventListener("submit", async (e) => {
      e.preventDefault();
      notifyStatus.textContent = "Saving...";
      const fd = new FormData(notifyForm);
      if (!fd.has("notify_email_enabled")) fd.append("notify_email_enabled", "0");
      if (!fd.has("notify_whatsapp_enabled")) fd.append("notify_whatsapp_enabled", "0");
      try {
        const res = await fetch("/business/notifications", { method: "POST", body: fd });
        const data = await res.json();
        notifyStatus.textContent = res.ok && data.ok ? "Saved" : (data.error || "Save failed");
      } catch (err) {
        notifyStatus.textContent = "Network error";
      }
    });
  }

  if (planForm) {
    planForm.addEventListener("submit", async (e) => {
      e.preventDefault();
      planStatus.textContent = "Saving...";
      const fd = new FormData(planForm);
      try {
        const res = await fetch("/business/plan", { method: "POST", body: fd });
        const data = await res.json();
        if (res.ok && data.ok) {
          planStatus.textContent = "Plan updated to " + (data.plan || "");
          setTimeout(() => window.location.reload(), 600);
        } else {
          planStatus.textContent = data.error || "Save failed";
        }
      } catch (err) {
        planStatus.textContent = "Network error";
      }
    });
  }

  function updatePhoneState() {
    const enabled = whatsappAllowed && whatsappCheckbox && whatsappCheckbox.checked;
    if (phoneInput) {
      phoneInput.disabled = !enabled;
    }
    if (whatsappCheckbox && !whatsappAllowed) {
      whatsappCheckbox.checked = false;
      whatsappCheckbox.disabled = true;
    }
  }
  updatePhoneState();
  if (whatsappCheckbox) {
    whatsappCheckbox.addEventListener("change", updatePhoneState);
  }
})();
</script>

</div>
{% endblock %}
