{% extends "base.html" %}
{% block content %}

<style>
  .page {
    display: flex;
    flex-direction: column;
    gap: 1.25rem;
  }

  .header-row {
    display: flex;
    align-items: flex-start;
    justify-content: space-between;
    gap: 1rem;
    flex-wrap: wrap;
  }

  .header-row h2 {
    margin: 0 0 0.25rem;
  }

  .header-row p {
    margin: 0;
    font-size: 0.95rem;
    color: var(--muted);
  }

  .status-pill {
    padding: 0.3rem 0.75rem;
    border-radius: 999px;
    border: 1px solid var(--border);
    background: var(--card);
    font-size: 0.85rem;
    color: var(--muted);
  }

  .trial-banner {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    gap: 0.9rem;
    margin: 0.25rem 0 0.5rem;
    padding: 0.9rem 1rem;
    border-radius: 0.9rem;
    border: 1px solid #38bdf8;
    background: linear-gradient(135deg, #0ea5e9 0%, #22c55e 100%);
    color: #f8fafc;
    box-shadow: 0 10px 25px rgba(0,0,0,0.08);
  }

  body.dark .trial-banner {
    background: linear-gradient(135deg, #0ea5e9 0%, #16a34a 100%);
    color: #e5e7eb;
    border-color: #38bdf8;
  }

  .trial-banner-main {
    font-size: 0.92rem;
  }

  .trial-banner-title {
    font-weight: 700;
    margin-bottom: 0.25rem;
  }

  .trial-banner-meta {
    font-size: 0.88rem;
    opacity: 0.95;
  }

  .trial-banner-countdown {
    font-size: 0.85rem;
    margin-top: 0.35rem;
  }

  .trial-banner-actions {
    display: flex;
    flex-direction: column;
    align-items: flex-end;
    gap: 0.4rem;
    min-width: 120px;
  }

  .trial-banner-link {
    font-size: 0.85rem;
    text-decoration: underline;
    color: inherit;
  }

  .trial-banner-dismiss {
    font-size: 0.82rem;
    border: none;
    border-radius: 999px;
    padding: 0.35rem 0.7rem;
    background: rgba(15,23,42,0.25);
    color: inherit;
    cursor: pointer;
  }

  .trial-banner-dismiss:hover {
    background: rgba(15,23,42,0.4);
  }

  .stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
    gap: 0.9rem;
  }

  .stat-card {
    background: var(--card);
    border: 1px solid var(--border);
    border-radius: 12px;
    padding: 0.9rem 1rem;
    box-shadow: 0 6px 16px rgba(15,23,42,0.05);
    transition: transform 0.12s ease, box-shadow 0.12s ease;
  }

  .stat-card:hover {
    transform: translateY(-1px);
    box-shadow: 0 10px 20px rgba(15,23,42,0.08);
  }

  .stat-label {
    font-size: 0.9rem;
    color: var(--muted);
    margin-bottom: 0.3rem;
  }

  .stat-value {
    font-size: 1.55rem;
    font-weight: 700;
  }

  .main-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
    gap: 1rem;
    align-items: start;
  }

  .card {
    background: var(--card);
    border: 1px solid var(--border);
    border-radius: 12px;
    padding: 1rem;
    box-shadow: 0 8px 18px rgba(15,23,42,0.06);
  }

  .card h3 {
    margin: 0 0 0.35rem;
    font-size: 1.05rem;
  }

  .card p {
    margin: 0 0 0.65rem;
    color: var(--muted);
    font-size: 0.92rem;
  }

  .section-label {
    display: inline-flex;
    align-items: center;
    gap: 0.4rem;
    font-size: 0.9rem;
    color: var(--muted);
    margin-bottom: 0.35rem;
  }

  #upload-zone {
    border: 1px dashed var(--border);
    padding: 0.95rem;
    text-align: center;
    margin: 0.6rem 0;
    cursor: pointer;
    font-size: 0.92rem;
    background: rgba(37, 99, 235, 0.04);
    border-radius: 10px;
    transition: border-color 0.15s ease, background 0.15s ease;
  }

  #upload-zone.dragover {
    border-color: #2563eb;
    background: rgba(37, 99, 235, 0.08);
  }

  .snippet {
    background: #0f172a;
    color: #e5e7eb;
    padding: 0.75rem;
    border-radius: 10px;
    font-family: Menlo, Consolas, monospace;
    font-size: 0.9rem;
    overflow-x: auto;
    margin: 0;
  }

  body.light .snippet {
    background: #111827;
  }

  .import-progress {
    display: none;
    margin-top: 0.5rem;
    padding: 0.6rem;
    border: 1px dashed var(--border);
    border-radius: 10px;
    background: rgba(37,99,235,0.03);
    color: var(--muted);
    width: 100%;
    box-sizing: border-box;
  }

  .import-progress-row {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    flex-wrap: wrap;
  }

  .import-spinner {
    width: 18px;
    height: 18px;
    border-radius: 50%;
    border: 2px solid rgba(37,99,235,0.2);
    border-top-color: #2563eb;
    animation: spin 0.8s linear infinite;
    flex-shrink: 0;
  }

  @keyframes spin {
    to { transform: rotate(360deg); }
  }

  .import-bar {
    position: relative;
    width: 100%;
    height: 6px;
    border-radius: 999px;
    background: rgba(37,99,235,0.12);
    overflow: hidden;
    margin-top: 8px;
  }

  .import-bar::after {
    content: "";
    position: absolute;
    left: -40%;
    top: 0;
    height: 100%;
    width: 40%;
    background: linear-gradient(90deg, rgba(37,99,235,0.3), #2563eb);
    animation: indeterminate 1.2s infinite;
  }

  @keyframes indeterminate {
    0% { left: -40%; }
    50% { left: 50%; }
    100% { left: 120%; }
  }

  #chat-panel {
    display: flex;
    flex-direction: column;
    border-radius: 12px;
    border: 1px solid var(--border);
    padding: 0.85rem;
    background: var(--card);
    min-height: 420px;
    max-height: 540px;
  }

  #chat {
    flex: 1;
    overflow-y: auto;
    padding: 0.25rem;
    display: flex;
    flex-direction: column;
    gap: 0.4rem;
  }

  .bubble {
    padding: 0.55rem 0.8rem;
    border-radius: 16px;
    max-width: 75%;
    font-size: 0.9rem;
    white-space: pre-wrap;
    line-height: 1.4;
    border: 1px solid transparent;
  }

  .user {
    background: #dbeafe;
    align-self: flex-end;
    border-bottom-right-radius: 4px;
    border-color: #bfdbfe;
  }

  .bot {
    background: #e5e7eb;
    align-self: flex-start;
    border-bottom-left-radius: 4px;
    border-color: #d1d5db;
  }

  body.dark .user {
    background: #1d4ed8;
    color: #e5e7eb;
    border-color: #1d4ed8;
  }

  body.dark .bot {
    background: #111827;
    color: #e5e7eb;
    border-color: #1f2937;
  }

  .chat-input-row {
    display: flex;
    gap: 0.5rem;
    margin-top: 0.5rem;
    border-top: 1px solid #e5e7eb;
    padding-top: 0.5rem;
  }

  body.dark .chat-input-row {
    border-top-color: #1f2937;
  }

  .chat-input-row input[type="text"] {
    flex: 1;
    padding: 0.45rem 0.6rem;
    border-radius: 6px;
    border: 1px solid #d1d5db;
    font-size: 0.9rem;
  }

  body.dark .chat-input-row input[type="text"] {
    background: #020617;
    border-color: #1f2937;
    color: var(--text);
  }

  .chat-input-row input[type="text"]::placeholder {
    color: #9ca3af;
  }

  .icon-button {
    border: 1px solid var(--border);
    background: var(--card);
    padding: 0.3rem;
    border-radius: 10px;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    transition: background 0.15s ease, border-color 0.15s ease;
  }

  .icon-button:hover {
    background: rgba(37, 99, 235, 0.08);
    border-color: #2563eb;
  }

  @media (max-width: 640px) {
    .trial-banner {
      flex-direction: column;
      align-items: flex-start;
    }
    .trial-banner-actions {
      align-items: flex-start;
    }
  }
</style>

<div class="tc-card page" data-has-imported-website="{{ 'true' if imported_website_url else 'false' }}">
  <div class="header-row">
    <div>
      <h1 class="tc-h1" style="margin-bottom:0.35rem;">TheoChat dashboard</h1>
      <p class="tc-subtext">Upload content, chat with your data, and drop the TheoChat snippet into your site.</p>
      <p style="margin:0.1rem 0 0.25rem;font-size:0.9rem;color:var(--muted);">Meet Theo - your website's new AI assistant.</p>
      <p style="margin:0;font-size:0.9rem;color:var(--muted);">Status: {{ trial_status }}</p>
    </div>
    <div class="status-pill">
      {{ trial_status }}
    </div>
  </div>

  {% if subscription_info and subscription_info.status == "trialing" %}
    <div id="trial-banner" class="trial-banner">
      <div class="trial-banner-main">
        <div class="trial-banner-title">
          You're currently in your 7-day free trial.
        </div>
        <div class="trial-banner-meta">
          All Pro features are enabled, including your live website widget.
          You can manage or cancel your subscription any time on the billing page.
          Cancel before your trial ends and you won’t be charged.
        </div>
        {% if trial_days_left is not none %}
          <div class="trial-banner-countdown">
            {% if trial_days_left > 1 %}
              {{ trial_days_left }} days left in your trial.
            {% elif trial_days_left == 1 %}
              1 day left in your trial.
            {% else %}
              Trial ends today.
            {% endif %}
          </div>
        {% endif %}
      </div>
      <div class="trial-banner-actions">
        <a href="{{ url_for('billing') }}" class="trial-banner-link">
          Go to billing
        </a>
        <button type="button" id="trial-banner-dismiss" class="trial-banner-dismiss">
          Dismiss for this session
        </button>
      </div>
    </div>

    <script>
      (function () {
        const banner = document.getElementById("trial-banner");
        const dismissBtn = document.getElementById("trial-banner-dismiss");
        if (!banner || !dismissBtn || !window.sessionStorage) return;

        const STORAGE_KEY = "trial-banner-dismissed";

        try {
          if (sessionStorage.getItem(STORAGE_KEY) === "1") {
            banner.style.display = "none";
            return;
          }
        } catch (e) {
          console.warn("sessionStorage unavailable", e);
        }

        dismissBtn.addEventListener("click", function () {
          banner.style.display = "none";
          try {
            sessionStorage.setItem(STORAGE_KEY, "1");
          } catch (e) {
            console.warn("sessionStorage write failed", e);
          }
        });
      })();
    </script>
  {% endif %}

  <div class="stats-grid">
    <a href="{{ url_for('knowledge') }}" style="text-decoration:none;color:inherit;">
      <div class="stat-card">
        <div class="stat-label">Knowledge chunks</div>
        <div class="stat-value" id="chunk-count-value">{{ chunk_count or 0 }}</div>
      </div>
    </a>
    <div class="stat-card">
      <div class="stat-label">Messages used</div>
      <div class="stat-value">{{ usage_messages or 0 }}</div>
    </div>
    <div class="stat-card">
      <div class="stat-label">Uploads</div>
      <div class="stat-value">{{ usage_uploads or 0 }}</div>
    </div>
  </div>

  <div class="main-grid">
    <div class="card">
      <h3>File upload (RAG)</h3>
      <p>Upload .txt / .md / .pdf to add to the knowledge base.</p>
      <label style="display:block;font-size:0.85rem;margin-bottom:0.25rem;">
        Optional label (e.g. "Menu", "FAQ"):
        <input type="text" id="upload-label" style="width:100%;margin-top:0.2rem;padding:0.3rem 0.4rem;font-size:0.9rem;border:1px solid #d1d5db;border-radius:6px;">
      </label>
      <div id="upload-zone">
        <strong>Click or drag a file here</strong><br>
        We'll chunk, embed, and store it for chat.
      </div>
      <input type="file" id="file-input" style="display:none" />
      <div style="margin-top:0.4rem;font-size:0.85rem;color:#6b7280;">
        Note: TheoChat reads your files into its knowledge base. The original files won’t stay stored on the server, but the extracted knowledge remains.
      </div>
      <div style="margin-top:1.25rem;">
        <h3 style="margin:0 0 0.35rem;">Import content from your website</h3>
        <p style="margin:0 0 0.75rem;color:var(--muted);">
          Paste your main website URL and TheoChat will crawl your site and import content to use in responses.
        </p>
        {% if not imported_website_url %}
          <form action="{{ url_for('import_site') }}" method="post" style="display:flex;flex-direction:column;gap:0.65rem;max-width:520px;">
            <input
              id="website-url-input"
              type="url"
              name="website_url"
              required
              placeholder="https://yourwebsite.com"
              value=""
              style="flex:1;padding:0.5rem;border-radius:6px;border:1px solid var(--border);font-size:0.95rem;"
            />
            <button
              id="website-import-button"
              type="submit"
              class="primary tc-btn-primary"
              style="align-self:flex-start;padding:0.5rem 1rem;border-radius:6px;"
            >
              Import website
            </button>
          </form>
        {% else %}
          <div style="display:flex;flex-direction:column;gap:0.35rem;max-width:520px;margin-top:0.35rem;">
            <label for="website-url-input" style="font-size:0.9rem;color:#6b7280;">Imported URL</label>
            <input
              id="website-url-input"
              type="url"
              value="{{ imported_website_url }}"
              disabled
              style="flex:1;padding:0.5rem;border-radius:6px;border:1px solid var(--border);font-size:0.95rem;background:#f8fafc;color:#6b7280;"
            />
            <form action="{{ url_for('import_site_reset') }}" method="post" style="display:flex;flex-direction:column;gap:0.35rem;">
              <button type="submit" class="secondary" style="align-self:flex-start;padding:0.45rem 0.9rem;border-radius:6px;">Reset website import</button>
              <div style="font-size:0.85rem;color:#6b7280;">
                Removes imported website content and clears the saved URL so you can start fresh.
              </div>
            </form>
          </div>
        {% endif %}
        <div id="import-progress" class="import-progress">
          <div class="import-progress-row">
            <div class="import-spinner" aria-hidden="true"></div>
            <div id="import-progress-text">Preparing import...</div>
          </div>
          <div id="import-progress-url" style="font-size:0.85rem;word-break:break-all;margin-top:0.2rem;color:var(--muted);"></div>
          <div class="import-bar" aria-hidden="true"></div>
        </div>
      </div>
    </div>

    <div class="card">
      <h3>Chat preview</h3>
      <p>Ask questions and watch responses stream from your TheoChat</p>
      <div id="chat-panel">
        <div id="chat"></div>
        <div class="chat-input-row">
          <input id="msg" type="text" placeholder="Type a message and press Enter..." />
          <button id="send" class="primary" type="button">Send</button>
        </div>
      </div>
    </div>
  </div>

  <div class="card">
    <h3>Business settings</h3>
    <p>Update your workspace name and restrict where the embed can be used.</p>
    <form method="post" action="{{ url_for('business_settings') }}" style="display:flex;flex-direction:column;gap:0.65rem;max-width:520px;">
      <label style="display:flex;flex-direction:column;gap:0.35rem;font-size:0.95rem;">
        <span>Business name</span>
        <input type="text" name="name" value="{{ business_name }}" style="padding:0.5rem 0.6rem;border:1px solid #d1d5db;border-radius:6px;" />
      </label>
      <label style="display:flex;flex-direction:column;gap:0.35rem;font-size:0.95rem;">
        <span>Allowed domains (comma-separated)</span>
        <input type="text" name="allowed_domains" value="{{ allowed_domains }}" placeholder="e.g. example.com, app.example.com" style="padding:0.5rem 0.6rem;border:1px solid #d1d5db;border-radius:6px;" />
      </label>
      <div class="text-sm text-gray-500 mt-1" style="margin:0.25rem 0 0.5rem;font-size:0.9rem;color:#6b7280;">
        Allowed domains control which hostnames can use this API key in the embed snippet. Leave blank to allow all.
      </div>
      <label style="display:flex;align-items:center;gap:0.4rem;font-size:0.9rem;margin-top:0.5rem;">
        <input type="checkbox" name="contact_enabled" id="contact_enabled" {% if contact_enabled %}checked{% endif %} />
        Allow TheoChat to send me contact requests
      </label>
      <label style="display:block;margin-top:0.4rem;font-size:0.85rem;">
        Contact email
        <input
          type="email"
          name="contact_email"
          id="contact_email"
          value="{{ contact_email or '' }}"
          placeholder="you@example.com"
          style="width:100%;margin-top:0.2rem;padding:0.4rem 0.5rem;border-radius:6px;border:1px solid #d1d5db;font-size:0.9rem;"
          {% if not contact_enabled %}disabled{% endif %}
        />
      </label>
      <button class="primary tc-btn-primary" type="submit" style="width:fit-content;">Save</button>
    </form>
  </div>

  <div class="card">
    <h3>Embed on your site</h3>
    {% if embed_available %}
      <p>Paste this snippet before &lt;/body&gt; or in your tag manager.</p>
<div class="tc-code-box">
  <pre class="tc-code-box" style="margin:0;padding:0;border:none;background:transparent;font-family:Consolas,'Courier New',monospace;">
<code class="language-html" id="embed-snippet-dashboard">{{- embed_snippet -}}</code>
  </pre>
</div>
      <button
        type="button"
        class="tc-copy-btn"
        data-copy-target="#embed-snippet-dashboard"
      >
        Copy snippet
      </button>
      <div style="display:flex;gap:0.65rem;align-items:center;margin-top:0.5rem;flex-wrap:wrap;">
        <a href="{{ url_for('setup') }}" style="font-size:0.9rem;color:#2563eb;text-decoration:none;">
          Need help adding this to your website? Click here
        </a>
      </div>
    {% else %}
      <p>Your embed code will appear here once you've added your business information and knowledge.</p>
    {% endif %}
  </div>
</div>

<script>
const chat = document.getElementById("chat");
const msg = document.getElementById("msg");
const send = document.getElementById("send");
const uploadZone = document.getElementById("upload-zone");
const fileInput = document.getElementById("file-input");
const labelInput = document.getElementById("upload-label");
const websiteUrlInput = document.getElementById("website-url-input");
const websiteImportButton = document.getElementById("website-import-button");
const importSiteUrl = "{{ url_for('import_site') }}";
const importProgressBox = document.getElementById("import-progress");
const importProgressText = document.getElementById("import-progress-text");
const importProgressUrl = document.getElementById("import-progress-url");
let importPoller = null;
let importStartTs = null;
const dashboardEl = document.querySelector(".tc-card.page");
const hasImportedWebsiteUrl = dashboardEl?.dataset.hasImportedWebsite === "true";

document.addEventListener("DOMContentLoaded", () => {
  if (websiteImportButton && hasImportedWebsiteUrl && websiteUrlInput && websiteUrlInput.disabled) {
    websiteImportButton.addEventListener("click", (e) => {
      if (!websiteUrlInput.disabled) return;
      e.preventDefault();
      websiteUrlInput.disabled = false;
      websiteUrlInput.style.background = "#fff";
      websiteUrlInput.style.color = "#111827";
      websiteUrlInput.style.cursor = "text";
      websiteImportButton.textContent = "Import website";
      websiteImportButton.type = "submit";
      websiteUrlInput.focus();
    });
  }

  const importForms = Array.from(document.querySelectorAll(`form[action="${importSiteUrl}"]`));

  function startPollingStatus() {
    if (importPoller) clearInterval(importPoller);
    importStartTs = Date.now();
    importPoller = setInterval(async () => {
      try {
        const res = await fetch("{{ url_for('import_status') }}");
        const data = await res.json();
        if (!data.ok) return;
        const pages = typeof data.pages_imported === "number" ? data.pages_imported : 0;
        const elapsedSec = importStartTs ? Math.max(0, Math.round((Date.now() - importStartTs) / 1000)) : 0;
        importProgressText.textContent = `Importing... Pages imported: ${pages}${elapsedSec ? ` · ${elapsedSec}s elapsed` : ""}`;
        if (data.last_url) {
          importProgressUrl.textContent = `Current page: ${data.last_url}`;
        }
        if (data.status === "done" || data.status === "error") {
          clearInterval(importPoller);
          setTimeout(() => {
            window.location = "{{ url_for('knowledge') }}";
          }, 350);
        }
      } catch (err) {
        console.warn("Import status check failed", err);
      }
    }, 1000);
  }

  function disableImportForms(disabled) {
    importForms.forEach((form) => {
      const btn = form.querySelector("button[type='submit'], button");
      if (btn) btn.disabled = disabled;
    });
    if (websiteUrlInput && disabled) {
      websiteUrlInput.style.cursor = "not-allowed";
    }
  }

  function submitImportForm(form) {
    const fd = new FormData(form);
    importProgressBox.style.display = "block";
    importProgressText.textContent = "Starting import...";
    importProgressUrl.textContent = "";
    disableImportForms(true);
    try {
      fetch(importSiteUrl, {
        method: "POST",
        body: fd
      }).catch(() => {});
    } catch (e) {
      console.warn("Import submit failed", e);
    }
    startPollingStatus();
  }

  importForms.forEach((form) => {
    form.addEventListener("submit", (e) => {
      e.preventDefault();
      submitImportForm(form);
    });
  });
});

function addBubble(text, cls) {
  const div = document.createElement("div");
  div.className = "bubble " + cls;
  div.textContent = text;
  chat.appendChild(div);
  chat.scrollTop = chat.scrollHeight;
  return div;
}

function setDisabled(disabled) {
  send.disabled = disabled;
  msg.disabled = disabled;
}

async function sendMsg() {
  const text = msg.value.trim();
  if (!text) return;

  addBubble(text, "user");
  msg.value = "";

  const botDiv = addBubble("...", "bot");
  setDisabled(true);

  try {
    const res = await fetch("/chat_stream", {
      method: "POST",
      headers: {"Content-Type": "application/json"},
      body: JSON.stringify({ message: text })
    });

    if (!res.ok) {
      const errText = await res.text();
      botDiv.textContent = errText || ("Error: " + res.status + " " + res.statusText);
      return;
    }

    const reader = res.body.getReader();
    const decoder = new TextDecoder();
    let botText = "";

    while (true) {
      const { value, done } = await reader.read();
      if (done) break;
      const chunk = decoder.decode(value, { stream: true });
      botText += chunk;
      botDiv.textContent = botText;
      chat.scrollTop = chat.scrollHeight;
    }
  } catch (e) {
    botDiv.textContent = "Network error";
  } finally {
    setDisabled(false);
    msg.focus();
  }
}

uploadZone.addEventListener("click", () => {
  fileInput.click();
});

uploadZone.addEventListener("dragover", (e) => {
  e.preventDefault();
  uploadZone.classList.add("dragover");
});

uploadZone.addEventListener("dragleave", (e) => {
  e.preventDefault();
  uploadZone.classList.remove("dragover");
});

uploadZone.addEventListener("drop", async (e) => {
  e.preventDefault();
  uploadZone.classList.remove("dragover");
  const file = e.dataTransfer.files[0];
  await uploadFile(file);
});

fileInput.addEventListener("change", async () => {
  const file = fileInput.files[0];
  await uploadFile(file);
});

async function uploadFile(file) {
  if (!file) return;

  const fd = new FormData();
  fd.append("file", file);
  const labelValue = labelInput ? labelInput.value.trim() : "";
  fd.append("label", labelValue);

  addBubble(`Uploaded: ${file.name}`, "user");
  const botDiv = addBubble("Processing file...", "bot");

  try {
    const res = await fetch("/upload", {
      method: "POST",
      body: fd
    });

    const data = await res.json();

    if (!res.ok || !data.ok) {
      botDiv.textContent = data.error || "Upload error";
      return;
    }

    botDiv.textContent =
      `File processed: ${data.filename}\n` +
      `Chunks stored: ${data.num_chunks}\n` +
      `You can now ask questions about this document.`;
    const chunkCountEl = document.getElementById("chunk-count-value");
    if (chunkCountEl && typeof data.total_chunks === "number") {
      chunkCountEl.textContent = data.total_chunks;
    }
  } catch (e) {
    botDiv.textContent = "Upload failed";
  }
}

send.addEventListener("click", sendMsg);
msg.addEventListener("keypress", (e) => { if (e.key === "Enter") sendMsg(); });

// Toggle contact email field based on checkbox
const contactCheckbox = document.getElementById("contact_enabled");
const contactEmailInput = document.getElementById("contact_email");

function updateEmailState() {
  if (!contactCheckbox || !contactEmailInput) return;
  contactEmailInput.disabled = !contactCheckbox.checked;
  contactEmailInput.style.opacity = contactEmailInput.disabled ? "0.5" : "1";
}

if (contactCheckbox) {
  contactCheckbox.addEventListener("change", updateEmailState);
  updateEmailState();
}

// Copy embed snippet helper
</script>

{% endblock %}
